<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Cart AI Scanner</title>
    <script src="edge-impulse-standalone.js"></script>
    <script src="run-impulse.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 420px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        video { width: 100%; border-radius: 15px; margin: 15px 0; display: none; border: 3px solid #007bff; }
        .inference-display { font-size: 24px; font-weight: bold; color: #007bff; margin: 15px 0; }
        .bar-container { background: #ddd; height: 8px; border-radius: 4px; margin: 5px 0 12px 0; overflow: hidden; }
        .bar-fill { background: #007bff; height: 100%; width: 0%; transition: width 0.2s; }
        button { width: 100%; padding: 15px; background: #007bff; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .btn-add { background: #28a745; display: none; }
        input { width: 90%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ›’ Smart Cart AI</h2>
    <input type="text" id="espIp" placeholder="ESP32 IP">
    <button id="startBtn">Start AI Scanner</button>
    
    <video id="webcam" autoplay muted playsinline></video>
    <div id="top-result" class="inference-display">Standby</div>
    
    <button id="addBtn" class="btn-add">âž• Add Item</button>

    <div id="conf-list" style="text-align: left; font-family: monospace; font-size: 14px;"></div>
    <div id="log" style="margin-top:10px; color:#666;"></div>
</div>

<script>
    let classifier;
    let detectionHistory = [];
    const targets = ["Deodorant", "Grips", "Hot sauce", "Power bank"];

    document.getElementById('startBtn').onclick = async () => {
        document.getElementById('startBtn').style.display = 'none';
        await initAI();
    };

    async function initAI() {
        const log = document.getElementById('log');
        try {
            log.innerText = "Initializing WASM...";
            classifier = new EdgeImpulseClassifier();
            await classifier.init();
            
            const props = classifier.getProperties();
            const video = document.getElementById('webcam');
            
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: 640, height: 640 } 
            });
            
            video.srcObject = stream;
            video.style.display = 'block';
            await video.play();

            log.innerText = "AI Running...";
            
            // Replaced setInterval with a self-calling async function to prevent UI locking
            async function inferenceCycle() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    const pixels = getPixelData(video, props.input_width, props.input_height);
                    
                    // console.log("Input Data Size:", pixels.length); // Should be 160*160*3 = 76800
                    
                    try {
                        const result = await classifier.classify(pixels);
                        if (result.results) {
                            updateUI(result.results);
                            check(result.results);
                        }
                    } catch (e) {
                        console.error("Classification error:", e);
                    }
                }
                setTimeout(inferenceCycle, 200); 
            }
            inferenceCycle();
        } catch (e) { log.innerText = "Error: " + e.message; }
    }

    function getPixelData(video, targetW, targetH) {
        const canvas = document.createElement('canvas');
        canvas.width = targetW;
        canvas.height = targetH;
        const ctx = canvas.getContext('2d', { alpha: false });

        // Official Client Crop Logic: Fit shortest axis
        const s = Math.min(video.videoWidth, video.videoHeight);
        const x = (video.videoWidth - s) / 2;
        const y = (video.videoHeight - s) / 2;

        ctx.drawImage(video, x, y, s, s, 0, 0, targetW, targetH);
        const imgData = ctx.getImageData(0, 0, targetW, targetH).data;
        
        const pixels = [];
        for (let i = 0; i < imgData.length; i += 4) {
            // Trying 0-1 Normalization (Standard for EI Mobile Client)
            pixels.push(imgData[i] / 255.0);
            pixels.push(imgData[i+1] / 255.0);
            pixels.push(imgData[i+2] / 255.0);
        }
        return pixels;
    }

    function updateUI(results) {
        let html = "";
        let top = { label: 'Searching...', value: 0 };
        results.forEach(res => {
            if (res.value > top.value) top = res;
            const p = (res.value * 100).toFixed(0);
            html += `<div>${res.label}: ${p}%<div class="bar-container"><div class="bar-fill" style="width: ${p}%"></div></div></div>`;
        });
        document.getElementById('top-result').innerText = top.value > 0.5 ? `${top.label} (${(top.value*100).toFixed(0)}%)` : "Searching...";
        document.getElementById('conf-list').innerHTML = html;
    }

    function check(results) {
        const best = results.filter(r => targets.includes(r.label)).sort((a,b) => b.value - a.value)[0];
        const addBtn = document.getElementById('addBtn');
        
        // Use 80% to match your successful Power Bank reading
        const found = (best && best.value > 0.8) ? best.label : null;
        detectionHistory.push(found);
        if (detectionHistory.length > 5) detectionHistory.shift();

        if (found && detectionHistory.filter(x => x === best.label).length >= 3) {
            addBtn.style.display = 'block';
            addBtn.innerText = `âž• Add ${found}`;
        } else {
            addBtn.style.display = 'none';
        }
    }
</script>
</body>
</html>
