<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Cart AI</title>
    <script src="edge-impulse-standalone.js"></script>
    <script src="run-impulse.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; text-align: center; background: #f0f2f5; margin: 0; padding: 15px; }
        .container { max-width: 400px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        video { width: 100%; border-radius: 15px; display: none; background: #000; border: 3px solid #007bff; }
        canvas { border: 2px solid red; margin: 10px auto; display: none; width: 160px; height: 160px; }
        .inference-display { font-size: 22px; font-weight: bold; color: #007bff; margin: 10px 0; }
        .bar-container { background: #ddd; height: 10px; border-radius: 5px; margin-bottom: 10px; overflow: hidden; }
        .bar-fill { background: #007bff; height: 100%; width: 0%; transition: width 0.2s; }
        button { width: 100%; padding: 15px; background: #007bff; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; margin-bottom: 10px; }
        #addBtn { background: #28a745; display: none; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .confidence-list { text-align: left; font-family: monospace; font-size: 13px; }
    </style>
</head>
<body>

<div class="container">
    <h3>ðŸ›’ Smart Cart AI</h3>
    <input type="text" id="espIp" placeholder="ESP32 IP Address">
    <button id="startBtn">Start Scanner</button>
    
    <video id="webcam" autoplay muted playsinline></video>
    <canvas id="debug-canvas"></canvas>
    
    <div id="top-result" class="inference-display">Ready</div>
    <button id="addBtn">âž• Add Detected Item</button>
    
    <div id="conf-list" class="confidence-list"></div>
    <div id="log" style="margin-top:10px; font-size:12px; color:#888;">Status: Waiting...</div>
</div>

<script>
    let classifier;
    let props;
    const targets = ["Deodorant", "Grips", "Hot sauce", "Power bank"];
    let history = [];

    const startBtn = document.getElementById('startBtn');
    const video = document.getElementById('webcam');
    const debugCanvas = document.getElementById('debug-canvas');
    const log = document.getElementById('log');

    startBtn.onclick = async () => {
        startBtn.style.display = 'none';
        try {
            log.innerText = "Status: Loading WASM...";
            classifier = new EdgeImpulseClassifier();
            await classifier.init();
            props = classifier.getProperties();
            
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: 640, height: 640 } 
            });
            video.srcObject = stream;
            video.style.display = 'block';
            debugCanvas.style.display = 'block';
            
            video.onloadedmetadata = () => {
                video.play();
                log.innerText = "Status: Running Inference";
                runLoop();
            };
        } catch (e) {
            log.innerText = "Error: " + e.message;
            console.error(e);
        }
    };

    async function runLoop() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            const pixels = getPixelData();
            try {
                const result = await classifier.classify(pixels);
                if (result.results) {
                    updateUI(result.results);
                }
            } catch (err) {
                console.error("Classification error:", err);
            }
        }
        setTimeout(runLoop, 200); 
    }

    function getPixelData() {
        const ctx = debugCanvas.getContext('2d', { alpha: false });
        debugCanvas.width = props.input_width;
        debugCanvas.height = props.input_height;

        const s = Math.min(video.videoWidth, video.videoHeight);
        const x = (video.videoWidth - s) / 2;
        const y = (video.videoHeight - s) / 2;

        ctx.drawImage(video, x, y, s, s, 0, 0, props.input_width, props.input_height);
        const imgData = ctx.getImageData(0, 0, props.input_width, props.input_height).data;
        
        const pixels = new Float32Array(props.input_width * props.input_height * 3);
        let j = 0;
        for (let i = 0; i < imgData.length; i += 4) {
            pixels[j++] = imgData[i] / 255.0;
            pixels[j++] = imgData[i+1] / 255.0;
            pixels[j++] = imgData[i+2] / 255.0;
        }
        return pixels;
    }

    function updateUI(results) {
        let top = { label: '', value: 0 };
        let html = "";
        
        results.forEach(res => {
            if (res.value > top.value) top = res;
            const p = (res.value * 100).toFixed(0);
            html += `<div>${res.label}: ${p}%<div class="bar-container"><div class="bar-fill" style="width:${p}%"></div></div></div>`;
        });

        document.getElementById('top-result').innerText = top.value > 0.6 ? top.label : "Searching...";
        document.getElementById('conf-list').innerHTML = html;

        const addBtn = document.getElementById('addBtn');
        if (top.value > 0.8 && targets.includes(top.label)) {
            addBtn.style.display = 'block';
            addBtn.onclick = () => sendToCart(top.label);
        } else {
            addBtn.style.display = 'none';
        }
    }

    async function sendToCart(item) {
        const ip = document.getElementById('espIp').value;
        if (!ip) return alert("Enter IP");
        log.innerText = "Sending " + item + "...";
        try {
            await fetch(`http://${ip}/add?label=${item}`, { mode: 'no-cors' });
            log.innerText = "Added: " + item;
        } catch (e) {
            log.innerText = "Network Error";
        }
    }
</script>
</body>
</html>
