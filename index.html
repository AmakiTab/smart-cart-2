<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Cart AI Scanner</title>
    <script src="edge-impulse-standalone.js"></script>
    <script src="run-impulse.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; background: #f4f7f9; margin: 0; padding: 20px; }
        .container { max-width: 450px; margin: auto; background: white; padding: 25px; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        video { width: 100%; border-radius: 15px; margin: 15px 0; display: none; border: 4px solid #007bff; object-fit: cover; }
        .inference-display { font-size: 26px; font-weight: 800; color: #007bff; margin: 15px 0; min-height: 36px; text-transform: capitalize; }
        .confidence-list { text-align: left; background: #f8f9fa; padding: 15px; border-radius: 12px; font-size: 14px; margin-top: 15px; border: 1px solid #eee; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; box-sizing: border-box; transition: border-color 0.3s; }
        input:focus { border-color: #007bff; outline: none; }
        button { width: 100%; padding: 16px; background: #007bff; color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-bottom: 12px; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-add { background: #28a745; display: none; }
        .btn-remove { background: #6c757d; font-size: 14px; padding: 10px; }
        #log { color: #555; font-weight: 600; margin-top: 15px; font-size: 14px; }
        .bar-container { background: #e9ecef; height: 10px; border-radius: 5px; margin: 4px 0 12px 0; overflow: hidden; }
        .bar-fill { background: #007bff; height: 100%; transition: width 0.3s ease-out; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="margin-top:0">üõí Smart Cart AI</h2>
    <input type="text" id="espIp" placeholder="ESP32 IP (e.g. 192.168.1.50)">
    <button id="startBtn">Launch Scanner</button>
    
    <video id="webcam" autoplay muted playsinline></video>
    <div id="top-result" class="inference-display">Standby</div>
    
    <div class="action-area">
        <button id="addBtn" class="btn-add">‚ûï Add Item</button>
        <button id="removeBtn" class="btn-remove">üîÑ Undo/Remove Last</button>
    </div>

    <div id="conf-list" class="confidence-list"></div>
    <div id="log">Status: Waiting for input</div>
</div>

<script>
    let classifier;
    let currentDetectedItem = null;
    let lastAddedItem = null; 
    
    // Labels must match exactly what is in your Edge Impulse "Output features" block
    const targets = ["Deodorant", "Grips", "Hot sauce", "Power bank"];

    const addBtn = document.getElementById('addBtn');
    const removeBtn = document.getElementById('removeBtn');
    const logDisplay = document.getElementById('log');

    document.getElementById('startBtn').onclick = async () => {
        document.getElementById('startBtn').style.display = 'none';
        await initAI();
    };

    addBtn.onclick = () => { 
        if (currentDetectedItem) sendToCart(currentDetectedItem, 'add'); 
    };

    removeBtn.onclick = () => {
        const itemToRemove = currentDetectedItem || lastAddedItem;
        if (itemToRemove) {
            sendToCart(itemToRemove, 'remove');
        } else {
            logDisplay.innerText = "‚ùå Nothing to remove";
            logDisplay.style.color = "#dc3545"; 
        }
    };

    async function initAI() {
        const statusDisplay = document.getElementById('top-result');
        try {
            statusDisplay.innerText = "Loading Model...";
            classifier = new EdgeImpulseClassifier();
            await classifier.init();
            
            const props = classifier.getProperties();
            // Force 160x160 logic based on your screenshot
            const modelW = 160; 
            const modelH = 160;

            const video = document.getElementById('webcam');
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: { ideal: 480 }, height: { ideal: 480 } } 
            });
            
            video.srcObject = stream;
            video.style.display = 'block';

            video.onloadedmetadata = () => {
                video.play();
                statusDisplay.innerText = "Scanning...";
                setInterval(async () => {
                    // Process RGB data at 160x160
                    const imgData = getPixelData(video, modelW, modelH);
                    const result = await classifier.classify(imgData);
                    if (result.results) {
                        updateUI(result.results);
                        checkDetection(result.results);
                    }
                }, 250); // Faster sampling for smoother UI
            };
        } catch (e) { 
            statusDisplay.innerText = "Error"; 
            logDisplay.innerText = e.message;
        }
    }

    // UPDATED: High-accuracy RGB extraction for 160x160
    function getPixelData(video, targetW, targetH) {
        const canvas = document.createElement('canvas');
        canvas.width = targetW;
        canvas.height = targetH;
        const ctx = canvas.getContext('2d');

        // Center crop logic (Fit shortest axis like your screenshot)
        const size = Math.min(video.videoWidth, video.videoHeight);
        const xOffset = (video.videoWidth - size) / 2;
        const yOffset = (video.videoHeight - size) / 2;
        
        ctx.drawImage(video, xOffset, yOffset, size, size, 0, 0, targetW, targetH);
        
        const img = ctx.getImageData(0, 0, targetW, targetH).data;
        const pixels = [];
        // Extract RGB (Ignore Alpha)
        for (let i = 0; i < img.length; i += 4) {
            pixels.push(img[i], img[i+1], img[i+2]);
        }
        return pixels;
    }

    function updateUI(classifications) {
        // Find the highest confidence result among our targets
        const topItem = classifications
            .filter(res => targets.includes(res.label))
            .sort((a, b) => b.value - a.value)[0];
        
        const display = document.getElementById('top-result');
        if (topItem && topItem.value > 0.4) {
            display.innerText = topItem.label;
            display.style.color = "#28a745";
        } else {
            display.innerText = "Scanning...";
            display.style.color = "#007bff";
        }

        let listHtml = "";
        classifications.sort((a, b) => b.value - a.value).forEach(res => {
            const percent = (res.value * 100).toFixed(0);
            const isTarget = targets.includes(res.label);
            listHtml += `
                <div style="display:flex; justify-content:space-between">
                    <span>${res.label}</span><span>${percent}%</span>
                </div>
                <div class="bar-container">
                    <div class="bar-fill" style="width: ${percent}%; background: ${isTarget && percent > 50 ? "#28a745" : "#bdc3c7"};"></div>
                </div>`;
        });
        document.getElementById('conf-list').innerHTML = listHtml;
    }

    function checkDetection(classifications) {
        // Only trigger "Add" if confidence is > 60%
        const bestItem = classifications
            .filter(res => targets.includes(res.label))
            .sort((a, b) => b.value - a.value)[0];

        if (bestItem && bestItem.value > 0.6) {
            currentDetectedItem = bestItem.label;
            addBtn.style.display = 'block';
            addBtn.innerText = `‚ûï Add ${bestItem.label}`;
        } else {
            currentDetectedItem = null;
            addBtn.style.display = 'none';
        }
    }

    function sendToCart(itemName, action) {
        const ip = document.getElementById('espIp').value;
        if (!ip) { alert("Enter ESP32 IP Address"); return; }

        logDisplay.innerText = `Sending: ${action} ${itemName}...`;
        
        const img = new Image();
        img.src = `http://${ip}/${action}?label=${encodeURIComponent(itemName)}&t=${Date.now()}`;
        
        img.onload = img.onerror = () => {
            if (action === 'add') {
                logDisplay.innerText = "‚úÖ Successfully Added";
                lastAddedItem = itemName;
            } else {
                logDisplay.innerText = "üóëÔ∏è Successfully Removed";
                if (lastAddedItem === itemName) lastAddedItem = null;
            }
        };
    }
</script>
</body>
</html>
